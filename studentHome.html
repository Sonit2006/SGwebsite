<html>

<head>
    <title> Student Genius</title>
    <link href="teacherHomeStyles.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="http://github.hubspot.com/odometer/themes/odometer-theme-car.css">
    <style>
        .odometer {
            font-size: 30px;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div id="banner">
            <button id="home" onclick="redirect()"><img src="logo.png"></button>
            <h1 align="center">Student Genius</h1>
        </div>
        <div id="main-content">
            <h2>Your Points</h2><br>
            <div id="myOdometer" class="odometer"></div><br>
            <div id="menu">
                <h2>Your Place:</h2>
                <div id="rankOdometer" class="odometer"></div><br>
                <div id="progress">
                    <canvas id="progressChart"></canvas>
                    <table>
                        <tr id="titles"></tr>
                        <tr id="quarter"></tr>
                    </table>
                </div>
                <select id="selectActivity" onchange="filter(recents)">
                    <option>Last 7 days</option>
                    <option>Last 14 days</option>
                    <option>Last 30 days</option>
                    <option>Last 90 days</option>
                    <option>School Year</option>
                </select>
            </div>
            <div class="left" id="updates">

            </div>
        </div>
    </div>

    </div>
    <div id="footer"></div>
    </div>
    <script src="https://cdn.botpress.cloud/webchat/v0/inject.js"></script>
    <script>
        window.botpressWebChat.init({
            "botId": "d7291e60-2ba1-4a68-b738-8c94b2b7056f",
            "hostUrl": "https://cdn.botpress.cloud/webchat/v0",
            "messagingUrl": "https://messaging.botpress.cloud",
            "clientId": "d7291e60-2ba1-4a68-b738-8c94b2b7056f",
            "showPoweredBy": true
        });
    </script>
    <script src="http://github.hubspot.com/odometer/odometer.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        console.log(urlParams.get("username"));
        fetch('http://localhost:3000/getOtherColumns?value=' + encodeURIComponent(urlParams.get("name")))
            .then(response => response.json())
            .then(data => {

                var odometer = new Odometer({
                    el: document.getElementById("myOdometer"), // Replace with your target element selector
                    value: 0,
                });
                odometer.update(data[0].Points);
            });

        fetch("http://localhost:3000/getRank")
            .then(response => response.json())
            .then(data => {
                for (let i = 0; i < data.length; i++) {
                    if (data[i].ID == urlParams.get("username")) {
                        var odometer = new Odometer({
                            el: document.getElementById("rankOdometer"), // Replace with your target element selector
                            value: 0,
                        });
                        odometer.update(i + 1);
                        break;
                    }
                }
            })
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
        var recents;
        fetch("http://localhost:3000/getActivity?value=" + encodeURIComponent(urlParams.get("username")))
            .then(response => response.json())
            .then(data => {
                console.log(data);
                filter(data);
            })

        function filter(data) {
            recents = data;
            document.getElementById("updates").innerHTML = '';
            for (let i = 0; i < data.length; i++) {
                if (document.getElementById("selectActivity").value.match(/\d+/) != null) {
                    if (data[i].date >= moment().subtract(parseInt(document.getElementById("selectActivity").value.match(/\d+/)), "days").format("YYYY-MM-DD")) {
                        const activity = document.createElement("p");
                        activity.textContent = data[i].activity + " on " + data[i].date;
                        document.getElementById("updates").appendChild(activity);
                    }
                }
                else {
                    if (data[i].date >= moment().subtract(1, "year").format("YYYY-MM-DD")) {
                        const activity = document.createElement("p");
                        activity.textContent = data[i].activity + " on " + data[i].date;
                        document.getElementById("updates").appendChild(activity);
                    }
                }
            }
        }
    </script>
    <script src="C:\Users\Sonit Maddineni\Documents\GitHub\SGwebsite\xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script>
        const name = urlParams.get("name");
        let pointRows = [];
        for (let i = 0; i < 3; i++) {
            if ((Number(moment().format("M")) >= [11, 1, 4][i]) && (Number(moment().format("M")) <= [11, 1, 4][i]) + 2) {
                for (let j = 0; j < i + 2; j++) {
                    const title = document.createElement("th");
                    title.textContent = "Quarter " + (j + 1).toString();
                    document.getElementById("titles").appendChild(title);
                    pointRows.push(document.createElement("td"));
                }
                break;
            }

        }


        fetch("http://localhost:3000/getReportData")
            .then(response => response.json())
            .then(data => {
                for (let i = 9; i < data.length; i++) {
                    console.log(data[i].includes(name),);
                    if (data[i].includes(name)) {
                        makeChart(data[i]);
                        for (let j = 0; j < pointRows.length; j++) {
                            console.log(data[i][data[i].indexOf(name) + j + 2]);
                            pointRows[j].textContent = data[i][data[i].indexOf(name) + j + 2];
                            document.getElementById("quarter").appendChild(pointRows[j]);
                        }
                        break;
                    }

                }
                // console.log(data);
            })

        function makeChart(list) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            let pointList = [];
            let labels = [];
            for (let j = 0; j < pointRows.length; j++) {
                labels.push("Quarter " + (j+1).toString());
                pointList.push(Number(list[list.indexOf(name) + j + 2]));
            }

            // Define your data for the chart
            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'My Dataset',
                        data: pointList,
                        backgroundColor: 'red',
                        borderColor: 'Blue',
                        borderWidth: 1
                    }
                ]
            };

            // Create the chart
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {}
            });

        }
    </script>
    
</body>

</html>